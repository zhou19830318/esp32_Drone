# 四旋翼飞行控制器

## 概述
本项目使用 MicroPython 在微控制器上实现了一个四旋翼飞行控制器，结合 MPU6050 惯性测量单元（IMU）。该控制器处理传感器数据，应用 PID 控制进行姿态稳定，并通过 PWM 信号驱动四个电机。同时包括接收机输入处理和失控保护机制。

## 功能
- **IMU 集成**：使用 MPU6050 获取 6 轴（加速度计 + 陀螺仪）数据，计算滚转和俯仰角度。
- **互补滤波**：融合加速度计和陀螺仪数据以获得准确的姿态估计。
- **双环 PID 控制**：
  - 外环：角度控制（滚转和俯仰）。
  - 内环：角速度控制（滚转、俯仰、偏航）。
- **接收机输入**：处理 6 通道接收机的 PWM 信号（滚转、俯仰、油门、偏航）。
- **失控保护**：当油门低于阈值（1030 µs）时切断电机电源。
- **电机混控**：将控制输入分配到四个电机以实现四旋翼稳定。
- **调试输出**：通过串口输出接收机值、角度、PID 输出和电机信号。

## 硬件要求
- **微控制器**：支持 MicroPython（例如 ESP32 或类似设备）。
- **IMU**：MPU6050 通过 I2C 连接（SCL：引脚 22，SDA：引脚 21）。
- **电机**：4 个电调（ESC）连接到 PWM 引脚（13、12、14、27）。
- **接收机**：6 通道 PWM 接收机，连接到引脚（34、35、32、33、25、26）。
- **电源**：适合电调和微控制器的电源。

## 软件要求
- **MicroPython**：在微控制器上安装固件。
- **库**：
  - `machine`（Pin、PWM、I2C）
  - `time`
  - `math`

## 设置步骤
1. **硬件连接**：
   - 将 MPU6050 连接到 I2C 引脚（SCL：22，SDA：21）。
   - 将电调连接到 PWM 引脚（13、12、14、27）。
   - 将接收机通道连接到输入引脚（34、35、32、33、25、26）。
   - 确保所有组件的电源供应正常。

2. **上传代码**：
   - 在微控制器上刷入 MicroPython 固件。
   - 将提供的脚本上传到微控制器。

3. **校准**：
   - 根据 IMU 的偏移调整校准常数（`RateCalibrationRoll`、`RateCalibrationPitch`、`RateCalibrationYaw`、`AccXCalibration`、`AccYCalibration`、`AccZCalibration`）。
   - 确保接收机输出 PWM 信号范围在 1000–2000 µs。

4. **运行**：
   - 启动系统。
   - 脚本将初始化 MPU6050 并进入主控制循环。
   - 监控串口输出以进行调试。

## 代码结构
- **全局参数**：定义校准值、PID 参数、电机 PWM 设置和接收机配置。
- **工具函数**：
  - `micros()`：返回当前时间（微秒）。
  - `servo_write_us()`：将微秒转换为 PWM 占空比。
  - `channel_irq()`：处理接收机 PWM 中断。
- **MPU6050 数据读取**：读取加速度计和陀螺仪数据，应用校准并计算角度。
- **PID 控制**：实现角度和角速度的级联 PID 控制。
- **主循环**：
  - 读取 IMU 数据。
  - 使用互补滤波进行姿态估计。
  - 处理接收机输入。
  - 计算滚转、俯仰和偏航的 PID 输出。
  - 进行电机混控并应用限幅。
  - 执行失控保护并输出到电机。
  - 使用定时保持 250Hz 控制循环。

## PID 调参
- **角度环**（`PAngleRoll`、`IAngleRoll`、`DAngleRoll` 等）：根据接收机输入调整目标角度。
- **角速度环**（`PRateRoll`、`IRateRoll`、`DRateRoll` 等）：稳定角速度。
- 谨慎调整 PID 参数以实现稳定飞行。从提供的参数开始，根据飞行表现进行微调。

## 调试
- 串口输出显示：
  - 接收机值（`RX`）。
  - 原始角度和互补滤波角度（`Angles`、`Comp`）。
  - PID 输出（`PID`）。
  - 电机 PWM 值（`Motors`）。
- 使用这些输出验证传感器读数、控制输入和电机响应。

## 安全须知
- 初次测试时移除螺旋桨。
- 验证失控保护功能以防止电机失控。
- 根据电调规格进行校准。
- 在受控环境中测试以避免损坏或伤害。

## 局限性
- 固定 250Hz 控制循环（4ms 周期）。
- 互补滤波假设小角度（限制在 ±20°）。
- 无高度或位置控制。
- 失控保护仅依赖油门通道。

## 未来改进
- 使用气压计或声呐添加高度保持功能。
- 实现自动水平或基于 GPS 的导航。
- 支持更多失控保护条件（例如信号丢失检测）。
- 针对特定四旋翼配置优化 PID 参数。

## 许可
本项目仅供教育用途，按原样提供，使用风险自负。
